name: 'Manual: Build Container Image'

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Custom tag for the image. Empty = auto-generated tag'
        required: false
        default: ''
        type: string

jobs:
  sanitize-tag:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.sanitize.outputs.tag }}
    steps:
      - name: Sanitize tag
        id: sanitize
        run: |
          RAW_TAG="${{ inputs.tag != '' && inputs.tag || format('{0}-{1}', github.ref_name, github.sha) }}"
          SANITIZED=$(echo "$RAW_TAG" | tr "/" "-")
          echo "tag=$SANITIZED" >> $GITHUB_OUTPUT

  build-image:
    needs: sanitize-tag
    uses: ./.github/workflows/build-image.yaml
    with:
      image_tags: ghcr.io/telekom/cluster-api-ipam-provider-infoblox:${{ needs.sanitize-tag.outputs.tag }}
